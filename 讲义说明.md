# Next.js 入门学习讲义

## 📖 课程概述

本讲义将带您深入了解 Next.js 的核心概念，通过一个完整的用户管理系统示例，学习前后端交互、路由系统、数据流程和部署等关键知识点。

## 🎯 学习目标

1. 理解 Next.js 的 App Router 架构
2. 掌握服务端渲染和客户端渲染的区别
3. 学会创建和使用 API 路由
4. 理解前后端数据交互流程
5. 掌握项目部署方法

---

## 🏗️ 第一部分：项目架构与路由系统

### 1.1 Next.js 14 App Router 架构

#### 核心概念
- **App Router**: Next.js 13+ 的新路由系统，基于文件系统
- **Server Components**: 默认在服务器端渲染的组件
- **Client Components**: 在客户端运行的交互式组件

#### 文件结构说明
```
app/
├── layout.tsx          # 根布局（所有页面共享）
├── page.tsx            # 首页 (/)
├── users/
│   ├── page.tsx        # 用户列表页 (/users)
│   └── [id]/
│       └── page.tsx    # 用户详情页 (/users/1, /users/2...)
└── api/
    └── users/
        ├── route.ts    # API 端点 (/api/users)
        └── [id]/
            └── route.ts # 单个用户 API (/api/users/1)
```

#### 路由规则
- `page.tsx` = 页面组件
- `layout.tsx` = 布局组件
- `route.ts` = API 路由
- `[id]` = 动态路由参数

### 1.2 路由类型详解

#### 静态路由
```typescript
// app/page.tsx → /
// app/about/page.tsx → /about
// app/contact/page.tsx → /contact
```

#### 动态路由
```typescript
// app/users/[id]/page.tsx → /users/1, /users/2, /users/3...
// app/posts/[slug]/page.tsx → /posts/hello-world, /posts/my-post...
```

#### 嵌套路由
```typescript
// app/dashboard/settings/page.tsx → /dashboard/settings
// app/dashboard/profile/page.tsx → /dashboard/profile
```

---

## 🔄 第二部分：数据获取与渲染策略

### 2.1 服务端渲染 (SSR)

#### 特点
- 页面在服务器端渲染
- SEO 友好
- 首屏加载快
- 适合内容型页面

#### 实现方式
```typescript
// app/users/page.tsx
export default function UsersPage() {
  // 数据在服务器端获取
  const users = [
    { id: 1, name: '张三', email: 'zhangsan@example.com' },
    { id: 2, name: '李四', email: 'lisi@example.com' }
  ]

  return (
    <div>
      {users.map(user => (
        <div key={user.id}>{user.name}</div>
      ))}
    </div>
  )
}
```

### 2.2 静态生成 (SSG)

#### 特点
- 构建时预渲染页面
- 性能最佳
- 适合内容不经常变化的页面

#### 实现方式
```typescript
// app/users/[id]/page.tsx
export async function generateStaticParams() {
  return [
    { id: '1' },
    { id: '2' },
    { id: '3' }
  ]
}

export default function UserPage({ params }: { params: { id: string } }) {
  // 根据 params.id 获取用户数据
  return <div>用户 {params.id}</div>
}
```

### 2.3 客户端数据获取

#### 特点
- 页面在客户端渲染
- 适合交互性强的页面
- 需要用户交互后获取数据

#### 实现方式
```typescript
'use client'

import { useState, useEffect } from 'react'

export default function ApiDemoPage() {
  const [users, setUsers] = useState([])
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    const fetchUsers = async () => {
      setLoading(true)
      const response = await fetch('/api/users')
      const data = await response.json()
      setUsers(data.data)
      setLoading(false)
    }

    fetchUsers()
  }, [])

  return (
    <div>
      {loading ? '加载中...' : (
        users.map(user => <div key={user.id}>{user.name}</div>)
      )}
    </div>
  )
}
```

---

## 🔌 第三部分：API 路由与后端开发

### 3.1 API 路由基础

#### 文件位置
- `app/api/route.ts` → `/api`
- `app/api/users/route.ts` → `/api/users`
- `app/api/users/[id]/route.ts` → `/api/users/1`

#### HTTP 方法处理
```typescript
// app/api/users/route.ts
import { NextRequest, NextResponse } from 'next/server'

// GET 请求
export async function GET() {
  return NextResponse.json({ users: [] })
}

// POST 请求
export async function POST(request: NextRequest) {
  const body = await request.json()
  return NextResponse.json({ message: '创建成功' })
}
```

### 3.2 完整的 CRUD API 示例

#### 获取用户列表 (GET)
```typescript
export async function GET() {
  try {
    const users = [
      { id: 1, name: '张三', email: 'zhangsan@example.com' }
    ]
    
    return NextResponse.json({
      success: true,
      data: users,
      message: '获取成功'
    })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '获取失败' },
      { status: 500 }
    )
  }
}
```

#### 创建用户 (POST)
```typescript
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { name, email } = body

    // 验证数据
    if (!name || !email) {
      return NextResponse.json(
        { success: false, message: '缺少必填字段' },
        { status: 400 }
      )
    }

    // 创建用户逻辑
    const newUser = { id: Date.now(), name, email }

    return NextResponse.json({
      success: true,
      data: newUser,
      message: '创建成功'
    }, { status: 201 })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '创建失败' },
      { status: 500 }
    )
  }
}
```

#### 更新用户 (PUT)
```typescript
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = parseInt(params.id)
    const body = await request.json()
    
    // 更新用户逻辑
    return NextResponse.json({
      success: true,
      message: '更新成功'
    })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '更新失败' },
      { status: 500 }
    )
  }
}
```

#### 删除用户 (DELETE)
```typescript
export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = parseInt(params.id)
    
    // 删除用户逻辑
    return NextResponse.json({
      success: true,
      message: '删除成功'
    })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '删除失败' },
      { status: 500 }
    )
  }
}
```

---

## 🔄 第四部分：前后端交互流程

### 4.1 完整的数据交互流程

#### 1. 用户访问页面
```
用户 → 浏览器 → Next.js 服务器
```

#### 2. 服务端渲染
```
Next.js 服务器 → 渲染页面 → 返回 HTML
```

#### 3. 客户端交互
```
用户点击按钮 → 客户端 JavaScript → 调用 API
```

#### 4. API 处理
```
API 路由 → 处理请求 → 返回数据
```

#### 5. 更新界面
```
客户端 → 接收数据 → 更新 DOM
```

### 4.2 实际代码示例

#### 前端组件
```typescript
'use client'

export default function UserForm() {
  const [formData, setFormData] = useState({
    name: '',
    email: ''
  })

  const handleSubmit = async (e) => {
    e.preventDefault()
    
    try {
      const response = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      
      const result = await response.json()
      
      if (result.success) {
        alert('创建成功！')
        setFormData({ name: '', email: '' })
      } else {
        alert(result.message)
      }
    } catch (error) {
      alert('创建失败')
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input
        value={formData.name}
        onChange={(e) => setFormData({...formData, name: e.target.value})}
        placeholder="姓名"
      />
      <input
        value={formData.email}
        onChange={(e) => setFormData({...formData, email: e.target.value})}
        placeholder="邮箱"
      />
      <button type="submit">创建用户</button>
    </form>
  )
}
```

#### 后端 API
```typescript
export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { name, email } = body

    // 数据验证
    if (!name || !email) {
      return NextResponse.json(
        { success: false, message: '缺少必填字段' },
        { status: 400 }
      )
    }

    // 业务逻辑处理
    const newUser = {
      id: Date.now(),
      name,
      email,
      createdAt: new Date()
    }

    // 返回结果
    return NextResponse.json({
      success: true,
      data: newUser,
      message: '用户创建成功'
    }, { status: 201 })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: '服务器错误' },
      { status: 500 }
    )
  }
}
```

---

## 🚀 第五部分：部署与上线

### 5.1 本地构建

#### 1. 安装依赖
```bash
npm install
```

#### 2. 构建项目
```bash
npm run build
```

#### 3. 启动生产服务器
```bash
npm start
```

### 5.2 Vercel 部署 (推荐)

#### 1. 准备代码
```bash
git add .
git commit -m "准备部署"
git push origin main
```

#### 2. 连接 Vercel
1. 访问 [vercel.com](https://vercel.com)
2. 使用 GitHub 账号登录
3. 点击 "New Project"
4. 选择你的仓库
5. 点击 "Deploy"

#### 3. 自动部署
- Vercel 会自动检测 Next.js 项目
- 自动运行 `npm run build`
- 部署到全球 CDN

### 5.3 其他部署平台

#### Netlify
```bash
# 构建命令
npm run build

# 发布目录
.next
```

#### 传统服务器
```bash
# 1. 构建项目
npm run build

# 2. 复制文件到服务器
scp -r .next user@server:/path/to/app

# 3. 安装依赖
npm install --production

# 4. 启动服务
npm start
```

---

## 📊 第六部分：性能优化

### 6.1 代码分割
- Next.js 自动进行代码分割
- 每个页面独立打包
- 按需加载组件

### 6.2 图片优化
```typescript
import Image from 'next/image'

export default function OptimizedImage() {
  return (
    <Image
      src="/avatar.jpg"
      alt="用户头像"
      width={100}
      height={100}
      priority
    />
  )
}
```

### 6.3 缓存策略
```typescript
// 静态页面缓存
export const revalidate = 3600 // 1小时

// 动态数据缓存
const data = await fetch('https://api.example.com/data', {
  next: { revalidate: 60 } // 1分钟
})
```

---

## 🔧 第七部分：开发工具与调试

### 7.1 开发服务器
```bash
npm run dev
# 访问 http://localhost:3000
```

### 7.2 代码检查
```bash
npm run lint
```

### 7.3 类型检查
```bash
npx tsc --noEmit
```

### 7.4 调试技巧

#### 1. 服务端调试
```typescript
console.log('服务端日志')
```

#### 2. 客户端调试
```typescript
'use client'
console.log('客户端日志')
```

#### 3. API 调试
```typescript
export async function GET() {
  console.log('API 被调用')
  return NextResponse.json({ message: 'Hello' })
}
```

---

## 📚 第八部分：最佳实践

### 8.1 文件组织
```
app/
├── components/          # 可复用组件
├── lib/                # 工具函数
├── types/              # TypeScript 类型
├── hooks/              # 自定义 Hooks
└── utils/              # 工具函数
```

### 8.2 错误处理
```typescript
// 全局错误处理
export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <html>
      <body>
        <h2>出错了！</h2>
        <button onClick={() => reset()}>重试</button>
      </body>
    </html>
  )
}
```

### 8.3 环境变量
```bash
# .env.local
DATABASE_URL=postgresql://...
API_KEY=your-api-key
```

```typescript
// 使用环境变量
const apiKey = process.env.API_KEY
const publicUrl = process.env.NEXT_PUBLIC_URL
```

---

## 🎯 总结

通过这个完整的 Next.js 示例项目，我们学习了：

1. **路由系统**: App Router 的文件系统路由
2. **数据获取**: SSR、SSG、客户端数据获取
3. **API 开发**: 创建 RESTful API 接口
4. **前后端交互**: 完整的数据流处理
5. **部署上线**: 多种部署方案
6. **性能优化**: 代码分割、缓存策略
7. **开发工具**: 调试和开发技巧
8. **最佳实践**: 项目组织和错误处理

这个项目为学习 Next.js 提供了完整的实践基础，涵盖了现代 Web 开发的核心概念和技术栈。

---

## 📖 延伸学习

- [Next.js 官方文档](https://nextjs.org/docs)
- [React 官方文档](https://react.dev)
- [TypeScript 官方文档](https://www.typescriptlang.org/docs)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)

祝您学习愉快！🚀 