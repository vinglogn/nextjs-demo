# Next.js 项目容器化部署说明

本文档详细说明了如何将 Next.js 项目部署到 Docker 容器中。

## 📋 目录

- [项目概述](#项目概述)
- [环境要求](#环境要求)
- [文件说明](#文件说明)
- [部署步骤](#部署步骤)
- [配置说明](#配置说明)
- [故障排除](#故障排除)
- [性能优化](#性能优化)

## 🎯 项目概述

这是一个基于 Next.js 14 的全栈应用，包含：
- 前端 React 组件
- API 路由
- TypeScript 支持
- Tailwind CSS 样式
- 用户管理功能演示

## 🔧 环境要求

### 必需软件
- **Docker**: 版本 20.10 或更高
- **Docker Compose**: 版本 2.0 或更高
- **Node.js**: 版本 18 或更高（用于本地开发）

### 系统要求
- 内存: 最少 2GB RAM
- 存储: 最少 5GB 可用空间
- 网络: 端口 3000 和 80 可用

## 📁 文件说明

### 核心文件
- `Dockerfile` - 多阶段构建配置
- `docker-compose.yml` - 容器编排配置
- `.dockerignore` - Docker 构建忽略文件
- `nginx.conf` - Nginx 反向代理配置

### 项目文件
- `package.json` - 项目依赖和脚本
- `next.config.js` - Next.js 配置
- `app/` - 应用代码目录

## 🚀 部署步骤

### 1. 克隆项目
```bash
git clone <your-repository-url>
cd nextjs-proj
```

### 2. 构建 Docker 镜像
```bash
# 构建镜像
docker build -t nextjs-demo .

# 查看构建的镜像
docker images | grep nextjs-demo
```

### 3. 运行容器

#### 方式一：使用 Docker 命令
```bash
# 运行容器
docker run -d \
  --name nextjs-app \
  -p 3000:3000 \
  -e NODE_ENV=production \
  nextjs-demo

# 查看容器状态
docker ps

# 查看日志
docker logs nextjs-app
```

#### 方式二：使用 Docker Compose（推荐）
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 验证部署
```bash
# 检查应用是否正常运行
curl http://localhost:3000

# 检查 API 端点
curl http://localhost:3000/api/users

# 在浏览器中访问
# http://localhost:3000
```

## ⚙️ 配置说明

### 环境变量
| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `NODE_ENV` | `production` | 运行环境 |
| `PORT` | `3000` | 应用端口 |
| `HOSTNAME` | `0.0.0.0` | 绑定地址 |
| `NEXT_TELEMETRY_DISABLED` | `1` | 禁用遥测 |

### 端口配置
- **3000**: Next.js 应用端口
- **80**: Nginx HTTP 端口
- **443**: Nginx HTTPS 端口（可选）

### 网络配置
- 使用自定义网络 `nextjs-network`
- 容器间通过服务名通信

## 🔍 故障排除

### 常见问题

#### 1. 容器启动失败
```bash
# 查看详细错误信息
docker-compose logs nextjs-app

# 检查端口占用
netstat -tulpn | grep :3000
```

#### 2. 构建失败
```bash
# 清理 Docker 缓存
docker system prune -a

# 重新构建
docker-compose build --no-cache
```

#### 3. 内存不足
```bash
# 检查系统资源
docker stats

# 限制容器内存使用
# 在 docker-compose.yml 中添加：
# deploy:
#   resources:
#     limits:
#       memory: 512M
```

#### 4. 网络连接问题
```bash
# 检查网络配置
docker network ls
docker network inspect nextjs-network

# 重启网络
docker-compose down
docker-compose up -d
```

### 日志查看
```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs nextjs-app

# 实时查看日志
docker-compose logs -f nextjs-app

# 查看最近 100 行日志
docker-compose logs --tail=100 nextjs-app
```

## 🚀 性能优化

### 1. 镜像优化
- 使用多阶段构建减少镜像大小
- 使用 Alpine Linux 基础镜像
- 排除不必要的文件

### 2. 运行时优化
```bash
# 设置资源限制
docker run -d \
  --name nextjs-app \
  --memory=512m \
  --cpus=1 \
  -p 3000:3000 \
  nextjs-demo
```

### 3. Nginx 优化
- 启用 Gzip 压缩
- 配置静态文件缓存
- 设置安全头

### 4. 监控和健康检查
```bash
# 添加健康检查
docker run -d \
  --name nextjs-app \
  --health-cmd="curl -f http://localhost:3000/api/health || exit 1" \
  --health-interval=30s \
  --health-timeout=10s \
  --health-retries=3 \
  -p 3000:3000 \
  nextjs-demo
```

## 🔄 更新部署

### 1. 更新代码
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### 2. 零停机更新
```bash
# 使用滚动更新
docker-compose up -d --no-deps nextjs-app
```

## 📊 监控和维护

### 1. 资源监控
```bash
# 查看容器资源使用情况
docker stats

# 查看系统资源
htop
```

### 2. 日志管理
```bash
# 设置日志轮转
# 在 docker-compose.yml 中添加：
# logging:
#   driver: "json-file"
#   options:
#     max-size: "10m"
#     max-file: "3"
```

### 3. 备份和恢复
```bash
# 备份镜像
docker save nextjs-demo > nextjs-demo-backup.tar

# 恢复镜像
docker load < nextjs-demo-backup.tar
```

## 🌐 生产环境部署

### 1. 使用 Docker Swarm
```bash
# 初始化 Swarm
docker swarm init

# 部署服务
docker stack deploy -c docker-compose.yml nextjs-stack
```

### 2. 使用 Kubernetes
```yaml
# 创建 deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nextjs-app
  template:
    metadata:
      labels:
        app: nextjs-app
    spec:
      containers:
      - name: nextjs-app
        image: nextjs-demo:latest
        ports:
        - containerPort: 3000
```

### 3. 使用云服务
- **AWS ECS**: 使用 Fargate 或 EC2
- **Google Cloud Run**: 无服务器容器
- **Azure Container Instances**: 简化容器部署

## 📞 支持和帮助

如果遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查 Docker 和 Docker Compose 版本
3. 查看项目 GitHub Issues
4. 联系开发团队

## 📝 更新日志

- **v1.0.0** - 初始版本，支持基本的容器化部署
- **v1.1.0** - 添加 Nginx 反向代理支持
- **v1.2.0** - 优化构建过程和性能

---

**注意**: 在生产环境中部署前，请确保：
- 所有敏感信息使用环境变量
- 配置适当的日志记录
- 设置监控和告警
- 定期更新依赖和基础镜像
